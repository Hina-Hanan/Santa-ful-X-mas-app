{% extends "base.html" %}

{% block progress_bar %}
<div class="progress-display">
    <span class="progress-label">Progress:</span>
    <span class="progress-percentage">{{ progress }}%</span>
</div>
{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Bangers&family=Fredoka+One&family=Nunito:wght@800;900&display=swap" rel="stylesheet">
<style>
    :root {
        --deep-burgundy: #2a0a0a;
        --evergreen: #013220;
        --evergreen-light: #025235;
        --gold: #d4af37;
        --gold-bright: #ffdf00;
        --white: #ffffff;
        --glass: rgba(255, 255, 255, 0.1);
        --glass-border: rgba(255, 255, 255, 0.2);
    }

    body {
        margin: 0;
        padding: 0;
        background: radial-gradient(circle at center, #3d0000 0%, var(--deep-burgundy) 100%);
        min-height: 100vh;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    /* Playful bold cartoon font for headings/titles only */
    h1, h2, h3, .elf-module-header h1, .scenario-box h2, .success-message h2 {
        font-family: 'Bangers', 'Fredoka One', 'Nunito', 'Comic Sans MS', 'Impact', 'Arial Black', sans-serif;
        font-weight: 900;
        letter-spacing: 0.05em;
        text-transform: uppercase;
    }

    /* Fixed Background Layer for Vignette */
    .vignette-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
        pointer-events: none;
        background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.6) 100%);
    }

    .elf-module-container {
        padding: 2rem;
        max-width: 1200px;
        margin: 0 auto;
        color: #ffffff;
        position: relative;
        z-index: 2;
    }

    .elf-module-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .elf-module-header h1 {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
    }

    .elf-module-header p {
        color: #888;
        font-size: 1.1rem;
    }

    .game-status {
        text-align: center;
        margin-bottom: 2rem;
        padding: 1rem;
        background: #0f0f0f;
        border: 2px solid #333;
        border-radius: 8px;
    }

    .game-status.completed {
        border-color: #4CAF50;
        background: rgba(76, 175, 80, 0.1);
    }

    .attempts-counter {
        color: #888;
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }

    .toys-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .broken-toy {
        background: #0f0f0f;
        border: 2px solid #333;
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        position: relative;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .broken-toy.fixed {
        border-color: #4CAF50;
        background: rgba(76, 175, 80, 0.1);
    }

    .toy-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        filter: grayscale(0.5);
        opacity: 0.7;
    }

    .broken-toy.fixed .toy-icon {
        filter: grayscale(0);
        opacity: 1;
    }

    .toy-name {
        font-size: 1.2rem;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .toy-status {
        font-size: 0.9rem;
        color: #888;
    }

    .broken-toy.fixed .toy-status {
        color: #4CAF50;
    }

    .drop-zone {
        width: 100%;
        height: 80px;
        border: 2px dashed #555;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 1rem;
        transition: all 0.3s ease;
    }

    .drop-zone.drag-over {
        border-color: #4a9eff;
        background: rgba(74, 158, 255, 0.1);
    }

    .drop-zone.filled {
        border-color: #4CAF50;
        background: rgba(76, 175, 80, 0.1);
    }

    .drop-zone-text {
        color: #666;
        font-size: 0.9rem;
    }

    .drop-zone.filled .drop-zone-text {
        display: none;
    }

    .part-placed {
        font-size: 2rem;
    }

    .parts-container {
        background: #0f0f0f;
        border: 2px solid #333;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .parts-container h3 {
        text-align: center;
        margin-bottom: 1.5rem;
        font-size: 1.3rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .parts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 1rem;
    }

    .spare-part {
        background: #1a1a1a;
        border: 2px solid #4a9eff;
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        cursor: grab;
        transition: all 0.3s ease;
        user-select: none;
    }

    .spare-part:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(74, 158, 255, 0.3);
    }

    .spare-part:active {
        cursor: grabbing;
    }

    .spare-part.used {
        opacity: 0.3;
        cursor: not-allowed;
        border-color: #333;
    }

    .part-icon {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }

    .part-name {
        font-size: 0.8rem;
        color: #888;
        text-transform: uppercase;
    }

    .module-actions {
        text-align: center;
        margin-top: 2rem;
    }

    .complete-button {
        display: inline-block;
        padding: 1rem 3rem;
        background: #4CAF50;
        color: #ffffff;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
    }

    .complete-button:hover {
        background: #45a049;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
    }

    .complete-button:disabled {
        background: #333;
        cursor: not-allowed;
        transform: none;
    }

    .back-button {
        display: inline-block;
        padding: 0.8rem 2rem;
        color: #ffffff;
        border: 2px solid #ffffff;
        text-decoration: none;
        font-size: 1rem;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        transition: all 0.3s ease;
        margin-left: 1rem;
    }

    .back-button:hover {
        background: #ffffff;
        color: #1a1a1a;
    }

    .success-message {
        text-align: center;
        padding: 2rem;
        background: rgba(76, 175, 80, 0.1);
        border: 2px solid #4CAF50;
        border-radius: 12px;
        margin-bottom: 2rem;
    }

    .success-message h2 {
        color: #4CAF50;
        font-size: 2rem;
        margin-bottom: 1rem;
    }

    /* Mobile and Touch Support */
    .spare-part.selected {
        border-color: #4CAF50;
        background: rgba(76, 175, 80, 0.2);
        transform: scale(1.1);
        box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
    }

    .drop-zone.ready-for-drop {
        border-color: #4CAF50;
        background: rgba(76, 175, 80, 0.2);
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0%, 100% {
            box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4);
        }
        50% {
            box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
        }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .elf-module-container {
            padding: 1rem;
        }

        .elf-module-header h1 {
            font-size: 1.8rem;
        }

        .toys-container {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .broken-toy {
            min-height: 180px;
            padding: 1rem;
        }

        .toy-icon {
            font-size: 3rem;
        }

        .drop-zone {
            height: 70px;
            min-height: 70px;
            touch-action: none;
        }

        .parts-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .spare-part {
            padding: 1.5rem 0.75rem;
            min-height: 100px;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }

        .part-icon {
            font-size: 2rem;
        }

        .part-name {
            font-size: 0.75rem;
        }
    }

    @media (max-width: 480px) {
        .elf-module-header h1 {
            font-size: 1.5rem;
        }

        .parts-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .spare-part {
            padding: 1.25rem 0.5rem;
            min-height: 90px;
        }

        .drop-zone {
            height: 60px;
            min-height: 60px;
        }

        .drop-zone-text {
            font-size: 0.8rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="vignette-overlay"></div>
<div class="elf-module-container">
    <div class="elf-module-header">
        <h1>üîß Elf Crisis: Toy Repair Station</h1>
        <p>Help the elves fix broken toys by matching the correct parts!</p>
    </div>

    {% if is_completed %}
    <div class="success-message">
        <h2>‚úì Module Completed!</h2>
        <p>All toys have been successfully repaired. Great work!</p>
    </div>
    {% else %}
    <div class="game-status" id="gameStatus">
        <div>Fix all 3 toys to complete the module</div>
        <div class="attempts-counter">Toys Fixed: <span id="fixedCount">0</span>/3</div>
        <div id="mobileInstructions" style="display: none; margin-top: 0.5rem; font-size: 0.85rem; color: #4a9eff;">
            üì± Tap a part to select it, then tap a drop zone to place it
        </div>
    </div>

    <div class="toys-container" id="toysContainer">
        <!-- Toys will be dynamically generated here -->
    </div>

    <div class="parts-container">
        <h3>Spare Parts</h3>
        <div class="parts-grid">
            <div class="spare-part" draggable="true" data-part="gear" data-part-icon="‚öôÔ∏è">
                <div class="part-icon">‚öôÔ∏è</div>
                <div class="part-name">Gear</div>
            </div>
            <div class="spare-part" draggable="true" data-part="wheel" data-part-icon="üõû">
                <div class="part-icon">üõû</div>
                <div class="part-name">Wheel</div>
            </div>
            <div class="spare-part" draggable="true" data-part="button" data-part-icon="üîò">
                <div class="part-icon">üîò</div>
                <div class="part-name">Button</div>
            </div>
            <div class="spare-part" draggable="true" data-part="spring" data-part-icon="ü™Ä">
                <div class="part-icon">ü™Ä</div>
                <div class="part-name">Spring</div>
            </div>
            <div class="spare-part" draggable="true" data-part="battery" data-part-icon="üîã">
                <div class="part-icon">üîã</div>
                <div class="part-name">Battery</div>
            </div>
            <div class="spare-part" draggable="true" data-part="eye" data-part-icon="üëÅÔ∏è">
                <div class="part-icon">üëÅÔ∏è</div>
                <div class="part-name">Eye</div>
            </div>
            <div class="spare-part" draggable="true" data-part="piece" data-part-icon="üß©">
                <div class="part-icon">üß©</div>
                <div class="part-name">Piece</div>
            </div>
            <div class="spare-part" draggable="true" data-part="string" data-part-icon="üßµ">
                <div class="part-icon">üßµ</div>
                <div class="part-name">String</div>
            </div>
        </div>
    </div>

    <div class="module-actions">
        <form method="POST" action="{{ url_for('complete_elf') }}" id="completeForm" style="display: none;">
            <button type="submit" class="complete-button" id="completeButton" disabled>Complete Module</button>
        </form>
        <a href="{{ url_for('map') }}" class="back-button">Back to Control Room</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<!-- Background Audio -->
<audio id="bgAudio" loop preload="auto" style="display: none;">
    <source src="{{ url_for('static', filename='assets/audio/bg_song2.mp3') }}" type="audio/mpeg">
</audio>

<script>
    // Background audio initialization
    (function() {
        function initBackgroundAudio() {
            const audio = document.getElementById('bgAudio');
            if (!audio) return;
            
            audio.volume = 0.5;
            
            function playAudio() {
                if (!audio.paused) return;
                
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.warn('Autoplay blocked:', error);
                    });
                }
            }
            
            audio.addEventListener('canplay', playAudio);
            audio.addEventListener('canplaythrough', playAudio);
            
            const events = ['click', 'touchstart', 'mousedown', 'keydown'];
            events.forEach(eventType => {
                document.addEventListener(eventType, playAudio, { once: true });
            });
            
            setTimeout(playAudio, 1000);
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initBackgroundAudio);
        } else {
            initBackgroundAudio();
        }
    })();
</script>

<script>
    {% if not is_completed %}
    (function() {
        let fixedCount = 0;
        const totalToys = 3;
        
        // All available toys (8 total)
        const allToys = [
            {
                id: 'robot',
                icon: 'ü§ñ',
                name: 'Broken Robot',
                part: 'gear',
                partIcon: '‚öôÔ∏è',
                partName: 'Gear'
            },
            {
                id: 'car',
                icon: 'üöó',
                name: 'Broken Car',
                part: 'wheel',
                partIcon: 'üõû',
                partName: 'Wheel'
            },
            {
                id: 'doll',
                icon: 'üß∏',
                name: 'Broken Doll',
                part: 'button',
                partIcon: 'üîò',
                partName: 'Button'
            },
            {
                id: 'train',
                icon: 'üöÇ',
                name: 'Broken Train',
                part: 'spring',
                partIcon: 'ü™Ä',
                partName: 'Spring'
            },
            {
                id: 'plane',
                icon: '‚úàÔ∏è',
                name: 'Broken Plane',
                part: 'battery',
                partIcon: 'üîã',
                partName: 'Battery'
            },
            {
                id: 'teddy',
                icon: 'üß∏',
                name: 'Broken Teddy',
                part: 'eye',
                partIcon: 'üëÅÔ∏è',
                partName: 'Eye'
            },
            {
                id: 'puzzle',
                icon: 'üß©',
                name: 'Broken Puzzle',
                part: 'piece',
                partIcon: 'üß©',
                partName: 'Piece'
            },
            {
                id: 'ball',
                icon: '‚öΩ',
                name: 'Broken Ball',
                part: 'string',
                partIcon: 'üßµ',
                partName: 'String'
            }
        ];

        // Randomly select 3 toys
        function getRandomToys(count) {
            const shuffled = [...allToys].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        const selectedToys = getRandomToys(3);
        
        // Build toyParts object from selected toys
        const toyParts = {};
        selectedToys.forEach(toy => {
            toyParts[toy.id] = toy.part;
        });

        // Render selected toys
        function renderToys() {
            const container = document.getElementById('toysContainer');
            container.innerHTML = '';
            
            selectedToys.forEach(toy => {
                const toyElement = document.createElement('div');
                toyElement.className = 'broken-toy';
                toyElement.setAttribute('data-toy', toy.id);
                toyElement.setAttribute('data-part', toy.part);
                toyElement.innerHTML = `
                    <div class="toy-icon">${toy.icon}</div>
                    <div class="toy-name">${toy.name}</div>
                    <div class="toy-status">Missing: ${toy.partName}</div>
                    <div class="drop-zone" data-toy="${toy.id}">
                        <div class="drop-zone-text">Drop ${toy.partIcon} here</div>
                    </div>
                `;
                container.appendChild(toyElement);
            });
        }

        // Initialize toys
        renderToys();

        // Get all draggable parts
        const parts = document.querySelectorAll('.spare-part');
        let dropZones = document.querySelectorAll('.drop-zone');
        let toys = document.querySelectorAll('.broken-toy');

        // Track selected part for touch devices
        let selectedPart = null;
        let isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

        // Show mobile instructions if on touch device
        if (isTouchDevice) {
            const mobileInstructions = document.getElementById('mobileInstructions');
            if (mobileInstructions) {
                mobileInstructions.style.display = 'block';
            }
        }

        // Drag and drop functionality for desktop
        parts.forEach(part => {
            part.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', JSON.stringify({
                    part: part.dataset.part,
                    icon: part.dataset.partIcon
                }));
            });
        });

        // Touch support for mobile devices
        if (isTouchDevice) {
            parts.forEach(part => {
                // Prevent default touch behaviors
                part.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    // Deselect previous part
                    if (selectedPart && selectedPart !== part) {
                        selectedPart.classList.remove('selected');
                    }
                    // Toggle selection
                    if (part.classList.contains('used')) {
                        return; // Can't select used parts
                    }
                    if (selectedPart === part) {
                        part.classList.remove('selected');
                        selectedPart = null;
                        dropZones.forEach(zone => zone.classList.remove('ready-for-drop'));
                    } else {
                        part.classList.add('selected');
                        selectedPart = part;
                        // Highlight available drop zones
                        dropZones.forEach(zone => {
                            if (!zone.classList.contains('filled')) {
                                zone.classList.add('ready-for-drop');
                            }
                        });
                    }
                }, { passive: false });

                // Prevent scrolling when touching parts
                part.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                }, { passive: false });
            });

        }

        function setupDropZones() {
            dropZones = document.querySelectorAll('.drop-zone');
            
            dropZones.forEach(zone => {
                // Remove existing listeners by cloning (to avoid duplicates)
                const newZone = zone.cloneNode(true);
                zone.parentNode.replaceChild(newZone, zone);

                newZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (!newZone.classList.contains('filled')) {
                        newZone.classList.add('drag-over');
                    }
                });

                newZone.addEventListener('dragleave', () => {
                    newZone.classList.remove('drag-over');
                });

                newZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    newZone.classList.remove('drag-over');

                    if (newZone.classList.contains('filled')) {
                        return;
                    }

                    const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                    handlePartDropData(data, newZone);
                });

                // Touch support for drop zones
                if (isTouchDevice) {
                    newZone.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        if (selectedPart && !newZone.classList.contains('filled')) {
                            handlePartDrop(selectedPart, newZone);
                        }
                    }, { passive: false });
                }
            });
        }

        // Setup drop zones after rendering
        setupDropZones();

        // Shared function to handle part drop (for both drag and touch)
        function handlePartDrop(partElement, zone) {
            if (!partElement || zone.classList.contains('filled')) {
                return;
            }

            const data = {
                part: partElement.dataset.part,
                icon: partElement.dataset.partIcon
            };

            handlePartDropData(data, zone, partElement);
        }

        function handlePartDropData(data, zone, partElement = null) {
            if (zone.classList.contains('filled')) {
                return;
            }

            const toy = zone.closest('.broken-toy');
            const toyName = toy.dataset.toy;
            const requiredPart = toy.dataset.part;

            // Check if the part matches
            if (data.part === requiredPart) {
                // Correct part!
                zone.classList.add('filled');
                zone.classList.remove('ready-for-drop');
                zone.innerHTML = `<div class="part-placed">${data.icon}</div>`;
                toy.classList.add('fixed');
                toy.querySelector('.toy-status').textContent = 'Fixed! ‚úì';
                toy.querySelector('.toy-status').style.color = '#4CAF50';

                // Mark part as used
                const usedPart = partElement || document.querySelector(`[data-part="${data.part}"]`);
                if (usedPart) {
                    usedPart.classList.add('used');
                    usedPart.classList.remove('selected');
                    usedPart.draggable = false;
                }

                // Clear selection for touch devices
                if (selectedPart === usedPart) {
                    selectedPart = null;
                }
                dropZones.forEach(z => z.classList.remove('ready-for-drop'));

                fixedCount++;
                updateGameStatus();

                if (fixedCount === totalToys) {
                    // All toys fixed!
                    document.getElementById('gameStatus').classList.add('completed');
                    document.getElementById('gameStatus').innerHTML = '<div>üéâ All toys fixed! Module complete!</div>';
                    document.getElementById('completeForm').style.display = 'inline-block';
                    document.getElementById('completeButton').disabled = false;
                }
            } else {
                // Wrong part - show feedback
                zone.style.borderColor = '#ff4444';
                zone.style.background = 'rgba(255, 68, 68, 0.1)';
                setTimeout(() => {
                    zone.style.borderColor = '';
                    zone.style.background = '';
                }, 500);
            }
        }

        function updateGameStatus() {
            document.getElementById('fixedCount').textContent = fixedCount;
        }
    })();
    {% endif %}
</script>
{% endblock %}


