{% extends "base.html" %}

{% block progress_bar %}
<div class="progress-display">
    <span class="progress-label">Progress:</span>
    <span class="progress-percentage">100%</span>
</div>
{% endblock %}

{% block extra_css %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Dancing+Script:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    body {
        overflow: hidden !important;
        background: radial-gradient(circle, #8b0000 0%, #4a0000 70%, #2a0000 100%);
    }

    .finale-container {
        width: 100vw;
        height: 100vh;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle, #8b0000 0%, #4a0000 70%, #2a0000 100%);
        overflow: hidden;
    }

    /* Snow animation */
    .snow {
        position: absolute;
        top: -10px;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
    }

    .snowflake {
        position: absolute;
        color: rgba(255, 255, 255, 0.8);
        font-size: 1.5rem;
        animation: fall linear infinite;
        opacity: 0.7;
    }

    @keyframes fall {
        0% {
            transform: translateY(-100px) translateX(0) rotate(0deg);
            opacity: 0;
        }
        10% {
            opacity: 0.7;
        }
        90% {
            opacity: 0.7;
        }
        100% {
            transform: translateY(100vh) translateX(50px) rotate(360deg);
            opacity: 0;
        }
    }

    /* Main content */
    .finale-content {
        position: relative;
        z-index: 10;
        text-align: center;
        color: #ffffff;
        max-width: 600px;
        padding: 1.5rem;
        width: 90%;
    }

    /* Santa entrance animation */
    .santa-container {
        margin-bottom: 1rem;
    }

    .santa-icon {
        font-size: 3rem;
    }

    /* Message reveal animations */
    .finale-title {
        font-family: 'Great Vibes', 'Dancing Script', cursive;
        font-size: 5.5rem;
        font-weight: 400;
        margin-bottom: 1rem;
        text-transform: none;
        letter-spacing: 0.05em;
        color: #ffffff;
        text-shadow: 0 0 20px rgba(255, 255, 255, 0.3), 2px 2px 10px rgba(0, 0, 0, 0.5);
    }

    .santa-message {
        font-size: 0.9rem;
        line-height: 1.5;
        color: #e0e0e0;
        margin-bottom: 1.5rem;
    }

    .success-banner {
        background: rgba(76, 175, 80, 0.15);
        border: 1px solid rgba(76, 175, 80, 0.5);
        border-radius: 8px;
        padding: 1rem;
        margin: 1.5rem 0;
        position: relative;
    }

    .success-text {
        font-size: 1rem;
        font-weight: 500;
        color: #4CAF50;
        position: relative;
        z-index: 1;
    }

    .finale-description {
        font-size: 0.85rem;
        color: #ccc;
        margin-top: 0.75rem;
        line-height: 1.4;
        position: relative;
        z-index: 1;
    }

    /* Stars background */
    .stars {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 2;
    }

    .star {
        position: absolute;
        width: 2px;
        height: 2px;
        background: #ffffff;
        border-radius: 50%;
        animation: twinkle 3s ease-in-out infinite;
    }

    @keyframes twinkle {
        0%, 100% {
            opacity: 0.3;
            transform: scale(1);
        }
        50% {
            opacity: 1;
            transform: scale(1.5);
        }
    }

    /* Action buttons */
    .finale-actions {
        margin-top: 1.5rem;
        display: flex;
        gap: 0.75rem;
        justify-content: center;
        flex-wrap: wrap;
    }

    .back-button, .home-button, .replay-button {
        display: inline-block;
        padding: 0.5rem 1rem;
        color: #ffffff;
        border: 1px solid #ffffff;
        text-decoration: none;
        font-size: 0.85rem;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        transition: all 0.2s ease;
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.1);
    }

    .replay-button {
        border-color: #ffd700;
        background: rgba(255, 215, 0, 0.15);
        color: #ffd700;
    }

    .back-button:hover, .home-button:hover {
        background: #ffffff;
        color: #1a1a1a;
    }

    .replay-button:hover {
        background: #ffd700;
        color: #1a1a1a;
    }

    /* Confetti effect */
    .confetti {
        position: absolute;
        width: 10px;
        height: 10px;
        background: #ffd700;
        position: absolute;
        animation: confettiFall 3s linear infinite;
    }

    @keyframes confettiFall {
        0% {
            transform: translateY(-100px) rotate(0deg);
            opacity: 1;
        }
        100% {
            transform: translateY(100vh) rotate(720deg);
            opacity: 0;
        }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .finale-content {
            max-width: 90%;
            padding: 1rem;
        }

        .finale-title {
            font-size: 3.5rem;
        }

        .santa-icon {
            font-size: 2.5rem;
        }

        .success-text {
            font-size: 0.9rem;
        }

        .santa-message {
            font-size: 0.85rem;
        }

        .back-button, .home-button, .replay-button {
            font-size: 0.75rem;
            padding: 0.4rem 0.8rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="finale-container">
    <!-- Snow effect -->
    <div class="snow" id="snow"></div>
    
    <!-- Stars background -->
    <div class="stars" id="stars"></div>

    <div class="finale-content">
        <!-- Santa -->
        <div class="santa-container">
            <div class="santa-icon"></div>
        </div>

        <!-- Title -->
        <h1 class="finale-title">Thank You</h1>

        <!-- Santa's Message -->
        <div class="santa-message">
            "Your dedication has made this Christmas possible. You've shown the true spirit of Christmas."
        </div>

        <!-- Success Banner -->
        <div class="success-banner">
            <div class="success-text">üéÑ Mission Accomplished üéÑ</div>
            <div class="finale-description">
                All modules completed. All hearts warmed.
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="finale-actions">
            <a href="{{ url_for('letter_intro') }}" class="replay-button">‚úâÔ∏è Write Letter to Santa</a>
            <a href="{{ url_for('map') }}" class="back-button">Back to Control Room</a>
            <a href="{{ url_for('index') }}" class="home-button">Return Home</a>
            <a href="{{ url_for('reset') }}" class="replay-button">üîÑ Replay Game</a>
        </div>
    </div>
</div>

<!-- Background Audio -->
<audio id="bgAudio" loop preload="auto" style="display: none;">
    <source src="{{ url_for('static', filename='assets/audio/bg_song.mp3') }}" type="audio/mpeg">
</audio>
{% endblock %}

{% block extra_js %}
<script>
    // Play background audio on finale page
    console.log('=== FINALE PAGE: AUDIO INITIALIZATION ===');
    
    function initBackgroundAudio() {
        const audio = document.getElementById('bgAudio');
        console.log('Audio element found:', !!audio);
        
        if (!audio) {
            console.error('ERROR: Audio element with id "bgAudio" not found!');
            return;
        }
        
        const audioUrl = "{{ url_for('static', filename='assets/audio/bg_song.mp3') }}";
        console.log('Audio URL:', audioUrl);
        
        audio.volume = 0.5;
        console.log('Audio volume set to:', audio.volume);
        
        function playAudio() {
            // Always try to play when page loads
            console.log('Attempting to play audio...');
            console.log('Audio readyState:', audio.readyState);
            console.log('Audio paused:', audio.paused);
            
            // If audio is already playing, don't restart it
            if (!audio.paused) {
                console.log('Audio is already playing');
                return;
            }
            
            const playPromise = audio.play();
            
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    console.log('‚úÖ SUCCESS: Audio is now playing!');
                    console.log('Audio volume:', audio.volume);
                    console.log('Audio paused:', audio.paused);
                }).catch(error => {
                    console.warn('‚ö†Ô∏è Autoplay blocked:', error.name, error.message);
                    console.log('Audio will play on next user interaction');
                });
            }
        }
        
        // Try to play when audio can play
        audio.addEventListener('canplay', function() {
            console.log('Audio can play event fired');
            playAudio();
        });
        
        audio.addEventListener('canplaythrough', function() {
            console.log('Audio can play through event fired');
            playAudio();
        });
        
        // Try to play on any user interaction
        const events = ['click', 'touchstart', 'mousedown', 'keydown'];
        events.forEach(eventType => {
            document.addEventListener(eventType, function() {
                console.log('User interaction detected:', eventType);
                playAudio();
            }, { once: true });
        });
        
        // Try to play after a delay
        setTimeout(function() {
            console.log('Timeout: Attempting to play audio');
            playAudio();
        }, 1000);
        
        // Handle audio errors
        audio.addEventListener('error', function(e) {
            console.error('‚ùå AUDIO ERROR:', e);
            console.error('Error details:', audio.error);
        });
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initBackgroundAudio);
    } else {
        initBackgroundAudio();
    }
</script>
<script>
    // Create snowflakes
    function createSnow() {
        const snowContainer = document.getElementById('snow');
        const snowflakeCount = 50;
        
        for (let i = 0; i < snowflakeCount; i++) {
            const snowflake = document.createElement('div');
            snowflake.className = 'snowflake';
            snowflake.textContent = '‚ùÑ';
            snowflake.style.left = Math.random() * 100 + '%';
            snowflake.style.animationDuration = (Math.random() * 3 + 2) + 's';
            snowflake.style.animationDelay = Math.random() * 2 + 's';
            snowContainer.appendChild(snowflake);
        }
    }

    // Create stars
    function createStars() {
        const starsContainer = document.getElementById('stars');
        const starCount = 100;
        
        for (let i = 0; i < starCount; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.animationDelay = Math.random() * 3 + 's';
            star.style.animationDuration = (Math.random() * 2 + 2) + 's';
            starsContainer.appendChild(star);
        }
    }

    // Create confetti
    function createConfetti() {
        const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#95e1d3', '#f38181'];
        const confettiCount = 30;
        
        for (let i = 0; i < confettiCount; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 0.5 + 's';
                confetti.style.width = (Math.random() * 10 + 5) + 'px';
                confetti.style.height = (Math.random() * 10 + 5) + 'px';
                document.querySelector('.finale-container').appendChild(confetti);
                
                setTimeout(() => {
                    confetti.remove();
                }, 3000);
            }, i * 100);
        }
    }

    // Initialize effects
    window.addEventListener('DOMContentLoaded', () => {
        createSnow();
        createStars();
        
        // Trigger confetti after a delay
        setTimeout(() => {
            createConfetti();
        }, 2000);
    });
</script>
{% endblock %}
