{% extends "base.html" %}

{% block progress_bar %}
<div class="progress-display">
    <span class="progress-label">Progress:</span>
    <span class="progress-percentage">{{ progress }}%</span>
</div>
{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Bangers&family=Fredoka+One&family=Nunito:wght@800;900&display=swap" rel="stylesheet">
<style>
    :root {
        --deep-burgundy: #2a0a0a;
        --evergreen: #013220;
        --evergreen-light: #025235;
        --gold: #d4af37;
        --gold-bright: #ffdf00;
        --white: #ffffff;
        --glass: rgba(255, 255, 255, 0.1);
        --glass-border: rgba(255, 255, 255, 0.2);
        
        /* Emotion Colors */
        --joy-color: #f1c40f;
        --energy-color: #e67e22;
        --hope-color: #9b59b6;
        --peace-color: #3498db;
        --kindness-color: #2ecc71;
        --courage-color: #e74c3c;
        --gratitude-color: #00bcd4;
    }

    body {
        margin: 0;
        padding: 0;
        background: radial-gradient(circle at center, #1a0505 0%, #050505 100%);
        height: 100vh;
        overflow: hidden !important; /* Force no scroll */
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    .vignette-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
        pointer-events: none;
        background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.8) 100%);
    }

    .emotion-module-container {
        padding: 1rem;
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        color: #ffffff;
        position: relative;
        z-index: 2;
        box-sizing: border-box;
    }

    .emotion-module-header {
        text-align: center;
        margin-bottom: 0.5rem;
        flex-shrink: 0;
    }

    .emotion-module-header h1 {
        font-size: 2.5rem;
        margin: 0;
        color: #fff;
        text-shadow: 0 0 20px rgba(76, 175, 80, 0.6);
    }

    .game-layout {
        display: flex;
        flex: 1;
        gap: 1rem;
        align-items: stretch;
        min-height: 0; /* Important for nested flex scroll */
    }

    .side-panel {
        width: 140px;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        justify-content: center;
        align-items: center;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        padding: 1rem;
        backdrop-filter: blur(10px);
        flex-shrink: 0;
    }

    .map-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #080808;
        border: 2px solid #222;
        border-radius: 30px;
        position: relative;
        box-shadow: inset 0 0 50px rgba(0,0,0,1);
        overflow: hidden;
    }

    .world-map-svg {
        width: 100%;
        height: 100%;
        max-height: 100%;
    }

    .emotion-draggable {
        width: 80px;
        height: 80px;
        background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.5) 0%, transparent 70%), rgba(255,255,255,0.1);
        border: 2px solid rgba(255,255,255,0.2);
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: grab;
        transition: all 0.3s ease;
        position: relative;
        box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        flex-shrink: 0;
    }

    .emotion-draggable:hover {
        transform: scale(1.1);
        border-color: rgba(255,255,255,0.6);
    }

    .emotion-draggable.dragging {
        opacity: 0.3;
        transform: scale(0.7);
    }

    .emotion-draggable[data-emotion="joy"] { background-color: rgba(241, 196, 15, 0.2); border-color: var(--joy-color); }
    .emotion-draggable[data-emotion="energy"] { background-color: rgba(230, 126, 34, 0.2); border-color: var(--energy-color); }
    .emotion-draggable[data-emotion="hope"] { background-color: rgba(155, 89, 182, 0.2); border-color: var(--hope-color); }
    .emotion-draggable[data-emotion="peace"] { background-color: rgba(52, 152, 219, 0.2); border-color: var(--peace-color); }
    .emotion-draggable[data-emotion="kindness"] { background-color: rgba(46, 204, 113, 0.2); border-color: var(--kindness-color); }
    .emotion-draggable[data-emotion="courage"] { background-color: rgba(231, 76, 60, 0.2); border-color: var(--courage-color); }
    .emotion-draggable[data-emotion="gratitude"] { background-color: rgba(0, 188, 212, 0.2); border-color: var(--gratitude-color); }

    .emotion-icon { font-size: 2rem; }
    .emotion-name { font-size: 0.7rem; font-weight: 900; text-transform: uppercase; }

    .region {
        cursor: pointer;
        transition: all 0.4s ease;
        stroke: rgba(255,255,255,0.1);
        stroke-width: 1;
        fill: #151515;
    }

    .region.drag-over { fill: rgba(255, 255, 255, 0.1); stroke: #fff; stroke-width: 2; }
    .region.fixed { stroke-width: 1.5; }

    .region-label { font-size: 14px; fill: rgba(255,255,255,0.3); font-weight: 600; text-anchor: middle; pointer-events: none; }
    .problem-icon { font-size: 2rem; pointer-events: none; filter: drop-shadow(0 0 5px rgba(0,0,0,0.8)); }
    .problem-label { font-size: 10px; font-weight: 700; text-anchor: middle; pointer-events: none; text-transform: uppercase; }

    .interaction-counter {
        text-align: center;
        margin: 0.5rem 0;
        font-family: 'Bangers', sans-serif;
        font-size: 1.2rem;
        flex-shrink: 0;
    }

    .interaction-counter span { color: var(--gold-bright); font-size: 1.8rem; }

    .module-actions {
        text-align: center;
        padding: 0.5rem;
        flex-shrink: 0;
    }

    .complete-button {
        padding: 0.8rem 3rem;
        background: linear-gradient(135deg, #4CAF50, #1B5E20);
        color: #fff;
        border: none;
        border-radius: 40px;
        font-size: 1.2rem;
        font-weight: bold;
        text-transform: uppercase;
        cursor: pointer;
    }

    .success-message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 80%;
        max-width: 500px;
        background: rgba(0, 0, 0, 0.9);
        border: 2px solid #4CAF50;
        padding: 2rem;
        border-radius: 20px;
        text-align: center;
        z-index: 100;
        backdrop-filter: blur(15px);
    }

    .particle {
        position: absolute;
        pointer-events: none;
        animation: explosion 2s forwards;
    }

    @keyframes explosion {
        0% { opacity: 1; transform: translate(0,0); }
        100% { opacity: 0; transform: translate(var(--tx), var(--ty)); }
    }

    /* Mobile handling - if screen is too small, revert or adjust */
    @media (max-width: 1000px) {
        .game-layout { flex-direction: column; overflow-y: auto; }
        .side-panel { width: 100%; flex-direction: row; flex-wrap: wrap; height: auto; }
        body { overflow: auto !important; }
    }
</style>
{% endblock %}

{% block content %}
<div class="vignette-overlay"></div>
<div class="emotion-module-container">
    <div class="emotion-module-header">
        <h1>üíö Global Harmony</h1>
    </div>

    <div class="interaction-counter">
        Stabilized: <span id="regionsCount">0</span>/7
    </div>

    <div class="game-layout">
        <!-- Left Panel: 4 Emotions -->
        <div class="side-panel">
            <div class="emotion-draggable" draggable="true" data-emotion="courage" id="emotion-courage">
                <div class="emotion-icon">ü¶Å</div>
                <div class="emotion-name">Courage</div>
            </div>
            <div class="emotion-draggable" draggable="true" data-emotion="joy" id="emotion-joy">
                <div class="emotion-icon">üéâ</div>
                <div class="emotion-name">Joy</div>
            </div>
            <div class="emotion-draggable" draggable="true" data-emotion="peace" id="emotion-peace">
                <div class="emotion-icon">üïäÔ∏è</div>
                <div class="emotion-name">Peace</div>
            </div>
            <div class="emotion-draggable" draggable="true" data-emotion="kindness" id="emotion-kindness">
                <div class="emotion-icon">ü§ù</div>
                <div class="emotion-name">Kindness</div>
            </div>
        </div>

        <!-- Center Map -->
        <div class="map-area" id="mapContainer">
            <div class="emotion-particles" id="particles"></div>
            <!-- Updated viewBox to 1000x600 to give Antarctica more breathing room at the bottom -->
            <svg class="world-map-svg" viewBox="0 0 1000 600" xmlns="http://www.w3.org/2000/svg">
                <!-- North America -->
                <g id="region-na-group">
                    <path class="region" id="region-na" d="M100,50 L120,40 L150,30 L200,20 L250,30 L280,50 L290,100 L270,150 L250,180 L220,210 L180,220 L140,210 L100,180 L80,150 L70,100 L80,70 Z" data-required-emotion="courage"/>
                    <text class="region-label" x="180" y="100">North America</text>
                    <text class="problem-icon" x="180" y="135" text-anchor="middle">‚ùÑÔ∏è</text>
                    <text class="problem-label" x="180" y="155" fill="#ff6b6b">Frozen</text>
                </g>

                <!-- South America -->
                <g id="region-sa-group">
                    <path class="region" id="region-sa" d="M220,220 L280,230 L310,260 L300,320 L270,380 L230,450 L190,400 L170,320 L180,260 L200,230 Z" data-required-emotion="joy"/>
                    <text class="region-label" x="240" y="300">South America</text>
                    <text class="problem-icon" x="240" y="335" text-anchor="middle">üåßÔ∏è</text>
                    <text class="problem-label" x="240" y="355" fill="#ff6b6b">Gloom</text>
                </g>

                <!-- Europe -->
                <g id="region-eu-group">
                    <path class="region" id="region-eu" d="M420,50 L480,40 L530,50 L550,100 L530,150 L480,160 L430,150 L400,100 Z" data-required-emotion="peace"/>
                    <text class="region-label" x="475" y="90">Europe</text>
                    <text class="problem-icon" x="475" y="125" text-anchor="middle">üì¢</text>
                    <text class="problem-label" x="475" y="145" fill="#ff6b6b">Chaos</text>
                </g>

                <!-- Africa -->
                <g id="region-af-group">
                    <path class="region" id="region-af" d="M420,170 L530,160 L580,200 L570,280 L530,350 L480,380 L420,350 L380,300 L390,220 Z" data-required-emotion="kindness"/>
                    <text class="region-label" x="480" y="250">Africa</text>
                    <text class="problem-icon" x="480" y="285" text-anchor="middle">ü•Ä</text>
                    <text class="problem-label" x="480" y="305" fill="#ff6b6b">Isolation</text>
                </g>

                <!-- Asia -->
                <g id="region-as-group">
                    <path class="region" id="region-as" d="M560,40 L700,20 L850,50 L920,120 L900,220 L800,280 L650,300 L580,250 L550,150 L540,80 Z" data-required-emotion="energy"/>
                    <text class="region-label" x="720" y="130">Asia</text>
                    <text class="problem-icon" x="720" y="165" text-anchor="middle">üí§</text>
                    <text class="problem-label" x="720" y="185" fill="#ff6b6b">Fatigue</text>
                </g>

                <!-- Australia -->
                <g id="region-au-group">
                    <path class="region" id="region-au" d="M780,320 L880,310 L920,350 L900,420 L820,430 L770,380 Z" data-required-emotion="hope"/>
                    <text class="region-label" x="845" y="365">Australia</text>
                    <text class="problem-icon" x="845" y="395" text-anchor="middle">üèúÔ∏è</text>
                    <text class="problem-label" x="845" y="415" fill="#ff6b6b">Drought</text>
                </g>

                <!-- Antarctica - Positioned and padded for visibility -->
                <g id="region-an-group">
                    <path class="region" id="region-an" d="M300,500 L700,500 L800,540 L200,540 Z" data-required-emotion="gratitude"/>
                    <text class="region-label" x="500" y="525" style="font-size: 14px;">Antarctica</text>
                    <text class="problem-icon" x="500" y="560" text-anchor="middle">üåë</text>
                    <text class="problem-label" x="500" y="580" fill="#ff6b6b">Forgotten</text>
                </g>
            </svg>
        </div>

        <!-- Right Panel: 3 Emotions -->
        <div class="side-panel">
            <div class="emotion-draggable" draggable="true" data-emotion="energy" id="emotion-energy">
                <div class="emotion-icon">‚ö°</div>
                <div class="emotion-name">Energy</div>
            </div>
            <div class="emotion-draggable" draggable="true" data-emotion="hope" id="emotion-hope">
                <div class="emotion-icon">‚ú®</div>
                <div class="emotion-name">Hope</div>
            </div>
            <div class="emotion-draggable" draggable="true" data-emotion="gratitude" id="emotion-gratitude">
                <div class="emotion-icon">üíé</div>
                <div class="emotion-name">Gratitude</div>
            </div>
        </div>
    </div>

    {% if is_completed %}
    <div class="success-message">
        <h2>‚ú® Mission Accomplished!</h2>
        <p>The entire planet is now balanced.</p>
        <a href="{{ url_for('map') }}" class="back-button">Back to Map</a>
    </div>
    {% else %}
    <form method="POST" action="{{ url_for('complete_emotion') }}" id="completeForm" style="display: none; margin-top: 1rem; text-align: center;">
        <button type="submit" class="complete-button" id="completeButton">Complete Mission</button>
    </form>
    <div class="module-actions">
        <a href="{{ url_for('map') }}" class="back-button">Back to Control Room</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<!-- Background Audio -->
<audio id="bgAudio" loop preload="auto" style="display: none;">
    <source src="{{ url_for('static', filename='assets/audio/bg_song2.mp3') }}" type="audio/mpeg">
</audio>

<script>
    (function() {
        function initBackgroundAudio() {
            const audio = document.getElementById('bgAudio');
            if (!audio) return;
            audio.volume = 0.5;
            function playAudio() {
                if (!audio.paused) return;
                const playPromise = audio.play();
                if (playPromise !== undefined) playPromise.catch(e => {});
            }
            const events = ['click', 'touchstart', 'mousedown', 'keydown'];
            events.forEach(e => document.addEventListener(e, playAudio, { once: true }));
            setTimeout(playAudio, 1000);
        }
        initBackgroundAudio();
    })();
</script>

<script>
    {% if not is_completed %}
    (function() {
        let fixedRegions = new Set();
        const totalRegions = 7;
        const emotionIcons = { 'hope': '‚ú®', 'joy': 'üéâ', 'energy': '‚ö°', 'peace': 'üïäÔ∏è', 'kindness': 'ü§ù', 'courage': 'ü¶Å', 'gratitude': 'üíé' };
        const emotionColors = { 'joy': '#f1c40f', 'energy': '#e67e22', 'hope': '#9b59b6', 'peace': '#3498db', 'kindness': '#2ecc71', 'courage': '#e74c3c', 'gratitude': '#00bcd4' };

        const draggableEmotions = document.querySelectorAll('.emotion-draggable');
        const regions = document.querySelectorAll('.region');

        draggableEmotions.forEach(emotion => {
            emotion.addEventListener('dragstart', function(e) {
                this.classList.add('dragging');
                e.dataTransfer.setData('text/plain', this.dataset.emotion);
            });
            emotion.addEventListener('dragend', function() {
                this.classList.remove('dragging');
                regions.forEach(r => r.classList.remove('drag-over'));
            });
        });

        regions.forEach(region => {
            region.addEventListener('dragover', e => e.preventDefault());
            region.addEventListener('dragenter', function() { this.classList.add('drag-over'); });
            region.addEventListener('dragleave', function() { this.classList.remove('drag-over'); });
            region.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                const emotion = e.dataTransfer.getData('text/plain');
                if (fixedRegions.has(this.id)) return;

                if (emotion === this.dataset.requiredEmotion) {
                    stabilizeRegion(this, emotion);
                } else {
                    this.classList.add('incorrect-drop');
                    setTimeout(() => this.classList.remove('incorrect-drop'), 600);
                }
            });
        });

        function stabilizeRegion(region, emotion) {
            region.classList.add('fixed');
            region.style.fill = emotionColors[emotion];
            region.style.stroke = '#fff';
            fixedRegions.add(region.id);
            document.getElementById('regionsCount').textContent = fixedRegions.size;

            const group = region.parentElement;
            const pIcon = group.querySelector('.problem-icon');
            const pLabel = group.querySelector('.problem-label');

            if (pIcon) pIcon.textContent = '‚úÖ';
            if (pLabel) {
                pLabel.textContent = 'Stabilized!';
                pLabel.style.fill = '#4CAF50';
            }

            createParticles(region, emotion);

            if (fixedRegions.size >= totalRegions) {
                setTimeout(() => {
                    const form = document.getElementById('completeForm');
                    if (form) form.style.display = 'block';
                    document.getElementById('completeButton').disabled = false;
                }, 800);
            }
        }

        function createParticles(region, emotion) {
            const container = document.getElementById('mapContainer');
            const particles = document.getElementById('particles');
            const svg = container.querySelector('svg');
            const rect = container.getBoundingClientRect();
            const bbox = region.getBBox();
            
            const svgPoint = svg.createSVGPoint();
            svgPoint.x = bbox.x + bbox.width / 2;
            svgPoint.y = bbox.y + bbox.height / 2;
            const screenPoint = svgPoint.matrixTransform(svg.getScreenCTM());
            const x = screenPoint.x - rect.left;
            const y = screenPoint.y - rect.top;

            for (let i = 0; i < 15; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.textContent = emotionIcons[emotion];
                p.style.left = x + 'px';
                p.style.top = y + 'px';
                p.style.setProperty('--tx', `${(Math.random() - 0.5) * 300}px`);
                p.style.setProperty('--ty', `${(Math.random() - 0.5) * 300}px`);
                p.style.animationDelay = (i * 0.05) + 's';
                p.style.color = emotionColors[emotion];
                particles.appendChild(p);
                setTimeout(() => p.remove(), 2500);
            }
        }
    })();
    {% endif %}
</script>
{% endblock %}
