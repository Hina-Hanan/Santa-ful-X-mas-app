{% extends "base.html" %}

{% block progress_bar %}
{% endblock %}

{% block extra_css %}
<style>
    :root {
        --deep-burgundy: #2a0a0a;
        --evergreen: #013220;
        --evergreen-light: #025235;
        --gold: #d4af37;
        --gold-bright: #ffdf00;
        --white: #ffffff;
        --glass: rgba(255, 255, 255, 0.1);
        --glass-border: rgba(255, 255, 255, 0.2);
    }

    body {
        margin: 0;
        padding: 0;
        background: radial-gradient(circle at center, #3d0000 0%, var(--deep-burgundy) 100%);
        min-height: 100vh;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    /* Fixed Background Layer for Vignette */
    .vignette-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
        pointer-events: none;
        background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.6) 100%);
    }

    .journey-container {
        position: relative;
        z-index: 2;
        max-width: 600px;
        margin: 0 auto;
        padding: 80px 20px 150px 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 1400px;
    }

    /* Candy Cane Path SVG */
    .path-container {
        position: absolute;
        top: 120px;
        left: 50%;
        transform: translateX(-50%);
        width: 400px;
        height: 800px;
        z-index: 1;
        pointer-events: none;
    }

    .candy-cane-path {
        fill: none;
        stroke-width: 30;
        stroke-linecap: round;
        filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.4)) drop-shadow(0 0 5px rgba(255, 0, 0, 0.6));
    }

    /* Level Nodes */
    .level-node-wrapper {
        position: absolute;
        z-index: 3;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* Absolute positioning based on SVG path curve */
    .node-1 { top: 120px; left: 50%; transform: translateX(-50%); }
    .node-2 { top: 320px; left: 75%; transform: translateX(-50%); }
    .node-3 { top: 520px; left: 25%; transform: translateX(-50%); }
    .node-4 { top: 720px; left: 50%; transform: translateX(-50%); }

    .level-node {
        width: 90px;
        height: 90px;
        border-radius: 50%;
        background: var(--glass);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 2px solid rgba(255, 255, 255, 0.2);
        display: flex;
        justify-content: center;
        align-items: center;
        text-decoration: none;
        color: white;
        font-size: 32px;
        font-weight: 800;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        position: relative;
        overflow: hidden;
        z-index: 5;
    }

    .level-node.completed {
        background: var(--evergreen);
        background: radial-gradient(circle at 30% 30%, var(--evergreen-light) 0%, var(--evergreen) 100%);
        border: 3px solid #ffffff;
        box-shadow: 
            0 0 20px rgba(1, 50, 32, 0.6),
            0 10px 25px rgba(0,0,0,0.5);
        color: white;
        opacity: 1;
        filter: none;
    }

    .level-node.active {
        background: var(--glass);
        animation: activePulse 2s infinite;
        transform: scale(1.1);
        border: 3px solid var(--gold-bright);
        color: white;
        opacity: 1;
    }

    .level-node.locked {
        background: rgba(0, 0, 0, 0.4);
        opacity: 0.5;
        cursor: not-allowed;
        border-color: rgba(255,255,255,0.1);
    }

    @keyframes activePulse {
        0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
        70% { box-shadow: 0 0 0 20px rgba(255, 255, 255, 0); }
        100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
    }

    .level-node:hover:not(.locked) {
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 15px 35px rgba(0,0,0,0.6);
    }

    .level-number {
        font-size: 32px;
        font-weight: 800;
        line-height: 1;
    }

    .level-label {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
    }

    .node-label {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        color: rgba(255,255,255,0.9);
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        white-space: nowrap;
    }

    .node-1 .node-label, .node-3 .node-label { right: 110px; }
    .node-2 .node-label, .node-4 .node-label { left: 110px; }

    /* Victory Area Style */
    .victory-reveal {
        position: absolute;
        top: 860px;
        left: 50%;
        transform: translateX(-50%);
        padding: 30px 20px;
        background: rgba(42, 10, 10, 0.4);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 30px;
        border: 1px solid rgba(255,255,255,0.1);
        text-align: center;
        animation: fadeInReveal 1s ease-out forwards;
        max-width: 450px;
        width: calc(100% - 40px);
        z-index: 10;
        box-shadow: 0 20px 50px rgba(0,0,0,0.4);
        margin: 0 auto;
    }

    @keyframes fadeInReveal {
        from { opacity: 0; transform: translateX(-50%) translateY(30px); }
        to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    .victory-status {
        color: white;
        font-size: 24px;
        font-weight: 300;
        letter-spacing: 3px;
        margin-bottom: 30px;
        text-transform: uppercase;
    }

    .btn-stack {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    /* Primary Gold Button with Sparkle */
    .btn-gold-sparkle {
        position: relative;
        padding: 18px 30px;
        background: linear-gradient(135deg, #ffd700 0%, #b8860b 100%);
        color: #2a0a0a;
        font-weight: 700;
        border-radius: 40px;
        text-decoration: none;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 14px;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: 0 10px 20px rgba(184, 134, 11, 0.3);
    }

    .btn-gold-sparkle:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 30px rgba(184, 134, 11, 0.5);
    }

    .btn-gold-sparkle::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.4) 0%, transparent 10%);
        background-size: 20px 20px;
        animation: sparkleMove 4s linear infinite;
        pointer-events: none;
    }

    @keyframes sparkleMove {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    /* Standardized White Label Button */
    .btn-white {
        padding: 16px 30px;
        background: white;
        color: #2a0a0a;
        font-weight: 600;
        border-radius: 40px;
        text-decoration: none;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .btn-white:hover {
        background: #f0f0f0;
        transform: translateY(-2px);
    }

    /* Minimal Glass Replay Button */
    .btn-glass-replay {
        padding: 14px 30px;
        background: rgba(255,255,255,0.05);
        color: rgba(255,255,255,0.7);
        border: 1px solid rgba(255,255,255,0.2);
        font-weight: 400;
        border-radius: 40px;
        text-decoration: none;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 12px;
        backdrop-filter: blur(5px);
        transition: all 0.3s ease;
    }

    .btn-glass-replay:hover {
        background: rgba(255,255,255,0.1);
        color: white;
        border-color: white;
    }

    /* Mission Progress Pill */
    .mission-header {
        position: fixed;
        top: 30px;
        z-index: 10;
        width: 100%;
        display: flex;
        justify-content: center;
    }

    .mission-pill {
        background: rgba(42, 10, 10, 0.6);
        backdrop-filter: blur(15px);
        padding: 10px 30px;
        border-radius: 30px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        font-size: 14px;
        font-weight: 600;
        letter-spacing: 2px;
        text-transform: uppercase;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .journey-container {
            min-height: 1500px;
            padding: 60px 15px 200px 15px;
        }
        
        .victory-reveal {
            top: 880px;
            padding: 25px 15px;
            width: calc(100% - 30px);
            max-width: 400px;
        }
        
        .btn-stack {
            gap: 12px;
        }
        
        .btn-gold-sparkle,
        .btn-white,
        .btn-glass-replay {
            padding: 14px 20px;
            font-size: 12px;
        }
    }
    
    @media (max-width: 500px) {
        .path-container { width: 300px; }
        
        .journey-container {
            min-height: 1600px;
            padding: 50px 10px 250px 10px;
        }
        
        .victory-reveal {
            top: 900px;
            padding: 20px 15px;
            width: calc(100% - 20px);
            max-width: 350px;
            border-radius: 20px;
        }
        
        .victory-status {
            font-size: 20px;
            margin-bottom: 20px;
        }
        
        .btn-stack {
            gap: 10px;
        }
        
        .btn-gold-sparkle,
        .btn-white,
        .btn-glass-replay {
            padding: 12px 18px;
            font-size: 11px;
            letter-spacing: 0.5px;
        }
    }
    
    @media (max-width: 400px) {
        .victory-reveal {
            top: 920px;
            padding: 18px 12px;
            width: calc(100% - 20px);
            max-width: 320px;
        }
        
        .victory-status {
            font-size: 18px;
            margin-bottom: 15px;
        }
        
        .btn-gold-sparkle,
        .btn-white,
        .btn-glass-replay {
            padding: 10px 15px;
            font-size: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="vignette-overlay"></div>

<div class="mission-header">
    <div class="mission-pill">Christmas Operation: {{ progress }}% Complete</div>
</div>

<div class="journey-container">
    <!-- Candy Cane Path SVG -->
    <div class="path-container">
        <svg width="100%" height="100%" viewBox="0 0 400 800" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <pattern id="candy-cane-pattern" patternUnits="userSpaceOnUse" width="40" height="40" patternTransform="rotate(45)">
                    <rect width="20" height="40" fill="#ff0000" />
                    <rect x="20" width="20" height="40" fill="#ffffff" />
                </pattern>
            </defs>
            <path class="candy-cane-path" d="M 200 0 Q 350 100 300 200 T 200 400 T 100 600 T 200 800" stroke="url(#candy-cane-pattern)" />
        </svg>
    </div>

    <!-- Level 1: Elf Crisis -->
    <div class="level-node-wrapper node-1">
        <a href="{{ url_for('elf_module') }}" 
           class="level-node {% if modules_completed.elf %}completed{% elif modules_accessible.elf %}active{% else %}locked{% endif %}">
            <div style="display: flex; flex-direction: column; align-items: center;">
                <span class="level-number">1</span>
                <span class="level-label">Level</span>
            </div>
        </a>
        <div class="node-label">Elf Crisis</div>
    </div>

    <!-- Level 2: Reindeer Navigation -->
    <div class="level-node-wrapper node-2">
        <a href="{% if modules_accessible.reindeer %}{{ url_for('reindeer_module') }}{% else %}#{% endif %}" 
           class="level-node {% if modules_completed.reindeer %}completed{% elif modules_accessible.reindeer %}active{% else %}locked{% endif %}">
            <div style="display: flex; flex-direction: column; align-items: center;">
                <span class="level-number">2</span>
                <span class="level-label">Level</span>
            </div>
        </a>
        <div class="node-label">Reindeer Navigation</div>
    </div>

    <!-- Level 3: Gift Ethics -->
    <div class="level-node-wrapper node-3">
        <a href="{% if modules_accessible.ethics %}{{ url_for('ethics_module') }}{% else %}#{% endif %}" 
           class="level-node {% if modules_completed.ethics %}completed{% elif modules_accessible.ethics %}active{% else %}locked{% endif %}">
            <div style="display: flex; flex-direction: column; align-items: center;">
                <span class="level-number">3</span>
                <span class="level-label">Level</span>
            </div>
        </a>
        <div class="node-label">Gift Ethics</div>
    </div>

    <!-- Level 4: Emotion Stabilizer -->
    <div class="level-node-wrapper node-4">
        <a href="{% if modules_accessible.emotion %}{{ url_for('emotion_module') }}{% else %}#{% endif %}" 
           class="level-node {% if modules_completed.emotion %}completed{% elif modules_accessible.emotion %}active{% else %}locked{% endif %}">
            <div style="display: flex; flex-direction: column; align-items: center;">
                <span class="level-number">4</span>
                <span class="level-label">Level</span>
            </div>
        </a>
        <div class="node-label">Emotion Stabilizer</div>
    </div>

    <!-- Finale Reveal Area -->
    {% if progress == 100 %}
    <div class="victory-reveal">
        <div class="victory-status">Mission Successful</div>
        <div class="btn-stack">
            <a href="{{ url_for('letter_intro') }}" class="btn-gold-sparkle">Get Customised Letter from Santa</a>
            <a href="{{ url_for('finale') }}" class="btn-white">You Did It!</a>
            <a href="{{ url_for('reset') }}" class="btn-glass-replay">Replay</a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Background Audio -->
<audio id="bgAudio" loop preload="auto" style="display: none;">
    <source src="{{ url_for('static', filename='assets/audio/bg_song.mp3') }}" type="audio/mpeg">
</audio>

<script>
    // Character messages logic and background audio
    document.addEventListener('DOMContentLoaded', function() {
        // Character messages logic
        const progress = {{ progress }};
        if (progress === 0) {
            setTimeout(() => {
                if (typeof showCharacterMessage === 'function') showCharacterMessage('santa');
            }, 1000);
        } else if (progress < 100 && progress > 0) {
            const messages = ['santa', 'elf', 'reindeer'];
            const random = messages[Math.floor(Math.random() * messages.length)];
            setTimeout(() => {
                if (typeof showCharacterMessage === 'function') showCharacterMessage(random);
            }, 2000);
        }

        // Play background audio - simplified and with extensive logging
        console.log('=== MAP PAGE: AUDIO INITIALIZATION ===');
        const audio = document.getElementById('bgAudio');
        console.log('Audio element found:', !!audio);
        
        if (audio) {
            const audioUrl = "{{ url_for('static', filename='assets/audio/bg_song.mp3') }}";
            const sourceElement = audio.querySelector('source');
            const actualSrc = sourceElement ? sourceElement.src : 'not found';
            
            console.log('Audio URL (from template):', audioUrl);
            console.log('Audio element src (actual):', actualSrc);
            console.log('Full audio element:', audio.outerHTML);
            
            // Test if the file is accessible
            fetch(audioUrl, { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        console.log('✅ Audio file is accessible at:', audioUrl);
                    } else {
                        console.error('❌ Audio file NOT accessible. Status:', response.status, response.statusText);
                        console.error('Tried URL:', audioUrl);
                    }
                })
                .catch(error => {
                    console.error('❌ Error checking audio file:', error);
                    console.error('Tried URL:', audioUrl);
                });
            
        audio.volume = 0.5;
        console.log('Audio volume set to:', audio.volume);
        
        function playAudio() {
            // Always try to play - don't check if already played
            // This ensures audio plays when navigating back to the page
            console.log('Attempting to play audio...');
            console.log('Audio readyState:', audio.readyState);
            console.log('Audio paused:', audio.paused);
            
            // If audio is already playing, don't restart it
            if (!audio.paused) {
                console.log('Audio is already playing');
                return;
            }
            
            const playPromise = audio.play();
            
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    console.log('✅ SUCCESS: Audio is now playing!');
                    console.log('Audio volume:', audio.volume);
                    console.log('Audio paused:', audio.paused);
                    console.log('Audio duration:', audio.duration);
                }).catch(error => {
                    console.warn('⚠️ Autoplay blocked:', error.name, error.message);
                    console.log('Audio will play on next user interaction');
                });
            }
        }
            
            // Try to play when audio can play
            audio.addEventListener('canplay', function() {
                console.log('Audio can play event fired');
                playAudio();
            });
            
            audio.addEventListener('canplaythrough', function() {
                console.log('Audio can play through event fired');
                playAudio();
            });
            
            audio.addEventListener('loadeddata', function() {
                console.log('Audio loadeddata event fired');
            });
            
            audio.addEventListener('error', function(e) {
                console.error('❌ AUDIO ERROR:', e);
                console.error('Error details:', audio.error);
                if (audio.error) {
                    console.error('Error code:', audio.error.code);
                    console.error('Error message:', audio.error.message);
                }
                console.error('Audio src:', audio.src);
                console.error('Audio source element:', audio.querySelector('source')?.src);
            });
            
            // Try to play on any user interaction
            const events = ['click', 'touchstart', 'mousedown', 'keydown'];
            events.forEach(eventType => {
                document.addEventListener(eventType, function() {
                    console.log('User interaction detected:', eventType);
                    playAudio();
                }, { once: true });
            });
            
            // Try to play after a delay
            setTimeout(function() {
                console.log('Timeout: Attempting to play audio');
                playAudio();
            }, 1000);
        } else {
            console.error('ERROR: Audio element with id "bgAudio" not found!');
        }
        
        console.log('=== MAP PAGE: AUDIO INITIALIZATION COMPLETE ===');
    });
</script>
{% endblock %}
